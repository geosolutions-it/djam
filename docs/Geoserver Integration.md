## Geoserver integration

#### Openid authentication
To be able to use Djam based authentication from Geoserver a recent build of geonode-oauth2 extension is required, because [this commit](https://github.com/geoserver/geoserver/commit/6e6ef47ce2bee359a705ce25c58fd8088f90417f) is required.

#### Auth-key / API-key authentication and authorization
##### Auth-key
Geoserver integration is possible also by AuthKey ([see documentation](https://docs.geoserver.org/stable/en/user/community/authkey/index.html)).
AuthKey is an UUID identifier of active user's session, which returns user's username and groups they belong to.
AuthKey is returned in the OpenID Code response along with ID and Access tokens, labelled as `session_token`, and can be used to authorize e.g. 
front-end requests to Geoserver.

Geoserver configuration for this authentication and authorization method:
* Login to Geoserver with admin privileges
* `Security` -> `Settings`: make sure Active role service is `default` (to prevent doubled checks for privileges in different Roles services)
* `Security` -> `Users, Groups, Roles`: `Add new` Role Service with the following parameters:
    * `AuthKEY REST` - Role service from REST endpoint
    * name: `djam_roleservice`
    * Base Server URL: `http://your-djam-domain`
    * Roles REST Endpoint: `/api/privilege/geoserver/roles`
    * Admin Role REST Endpoint: `/api/privilege/geoserver/adminRole`
    * Users REST Endpoint: `/api/privilege/geoserver/users` [note: this endpoint won't be used in this integration]
    * Roles JSON Path: `$.groups`
    * Admin Role JSON Path: `$.adminRole`
    * Users JSON Path: `$.users[?(@.username=='${username}')].groups`
    * REST Rules Cache Concurrency Level: `4`
    * REST Rules Cache Maximum Size (# keys): `10000`
    * REST Rules Cache Expiration Time (ms): `30000`
* `Security` -> `Users, Groups, Roles`: `Add new` User Group Service with the following parameters:
    * `AuthKEY WebService Body Response` - UserGroup Service from WebService Response Body
    * name: `djam_groupservice`
    * Password encryption: `Empty`
    * Password policy: `default`
    * Web Service Response Roles Search Regular Expression: `^.*?"groups"\s*:\s*\["([^"]+)"\].*$`
    * Optional static comma-separated list of available Groups from the Web Service response: leave this empty
    * Role Service to use (empty value means: use the current Active Role Service): `djam_roleservice`
* `Security` -> `Authentication`: `Add new` Authentication Filter with the following parameters:
    * `AuthKey` - Authenticates by looking up for an authentication key sent as URL parameter
    * name: `djam_filter`
    * name of URL parameter: `apikey`
    * Authentication key to user mapper: `Web Service`
    * Web Service URL, with key placeholder: `http://your-djam-domain/openid/authkey/introspect/?authkey={key}&format=json`
    * Web Service Response User Search Regular Expression: `^.*?\"username\"\s*:\s*\"([^\"]+)\".*$`
    * User/Group Service: `djam_groupservice`
* `Security` -> `Authentication` -> `Filter Chains`:
    * `web` -> `Chain filters`: move `djam_filter` for "available" to "selected" column, ABOVE `anonymous` filter and press Close
    * `default` -> `Chain filters`: move `djam_filter` for "available" to "selected" column, ABOVE `anonymous` filter and press Close
    * **Remember** to press `Save` at the bottom of the `Authentication` page, otherwise the settings won't be applied!

From now on you can authenticate your requests to Geoserver by attaching `apikey` parameter to a querystring, e.g. 
`http://your-domain/geoserver/geonode/wms?service=WMS&...&apikey=84fb7e8d-9642-4ec7-b8e3-a6447ad1c709`.

##### API key
The AuthKey mechanism in Geoserver can also be used for programmatic access authentication - API key validation, using the same configuration and Djam endpoint.
In Djam, API key can be generated by staff users in admin panel. Each API key represents a certain User for some 3rd party application,
so they have the same privilege groups assigned as the User.

#### Basic Auth credentials validation
To be able to use Basic Auth authentication from in Geoserver with credentials vaildation in Djam [this](https://github.com/geosolutions-it/geoserver/issues/145) feature of Geoserver is required.

Another method of authenticating requests in Geoserver is User credentials validation by Djam. To do so you need to make a GET request to a view named
`user_credentials_introspection` with parameters `u` (user's username - by default it's their email) and `p` (user's password).

Generally, usage of this authentication method is discouraged. It should only be used in certain, controlled environments. When using this 
flow in a production environment, make sure `REQUIRE_SECURE_HTTP_FOR_GEOSERVER_INTROSPECTION` setting is `True` 
(djam/project/conf/prod/identity_provider.py).
